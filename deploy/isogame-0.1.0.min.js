var isogame=isogame||{};isogame.compareArrays=function(t,i){for(var s=0;t.length>s;s++)if(t[s]!=i[s])return!1;return!0},isogame.ArrayList=function(){function t(t){this._array=t?t.slice():[]}return t.prototype={add:function(t){this._array.push(t)},addAll:function(t){var i=this;t.iterate(function(t,s){i.add(s)})},clear:function(){this._array=[]},contains:function(t,i){return-1!==this.indexOf(t,i)},containsAll:function(t,i){var s=this,e=!0;return t.iterate(function(t,o){return s.contains(o,i)?void 0:(e=!1,!0)}),e},get:function(t){return this._array[t]},indexOf:function(t,i){var s=-1,e=this.getComparator(i);return this.iterate(function(i,o){return e(t,o)?(s=i,!0):void 0}),s},isEmpty:function(){return 0===this._array.length},removeAt:function(t){this._array.splice(t,1)},remove:function(t,i){var s,e=this.getComparator(i);this.iterate(function(i,o){return e(t,o)?(s=i,!0):void 0}),this.removeAt(s)},removeAll:function(t,i){var s=this;t.iterate(function(t,e){s.remove(e,i)})},retainAll:function(t,i){var s=this;this.iterate(function(e,o){t.contains(o,i)||s.remove(o,i)})},set:function(t,i){this._array[t]=i},size:function(){return this._array.length},subList:function(t,i){return new js.util.ArrayList(this._array.slice(t,i))},toArray:function(){return this._array.slice()},getComparator:function(t){return void 0!==t?t:this._defaultComparator},_defaultComparator:function(t,i){return t===i},iterate:function(t){for(var i=this._array,s=i.length-1;s>=0&&!t(s,i[s]);s--);},reduce:function(t){var i=this;this.iterate(function(s,e){t(s,e)||i.removeAt(s)})}},t}(),isogame.Set=function(){function t(t){isogame.ArrayList.constructor.call(this),t&&this.addAll(new collections.ArrayList(t))}return t.prototype=ooputils.inherit(isogame.ArrayList.prototype),ooputils.extend(t.prototype,{constructor:t,add:function(t,i){this.contains(t,i)||isogame.ArrayList.prototype.add.call(this,t)},addAll:function(t,i){var s=this;t.iterate(function(t,e){s.add(e,i)})}}),t.prototype={},t}(),isogame.Point=function(){function t(t,i){t!==void 0&&(this.x=parseInt(t)),i!==void 0&&(this.y=parseInt(i))}return t}(),isogame.Rectangle=function(){function t(t,i,s,e){t!==void 0&&(this.x=parseInt(t)),i!==void 0&&(this.y=parseInt(i)),s!==void 0&&(this.width=parseInt(s)),e!==void 0&&(this.height=parseInt(e))}return t}(),isogame.Constants=function(){function t(){}return t.errors={INVALID_SPRITE_XML:"not a valid XML-sprite file",SPITE_MOVE_SPEED_ODD:"Movespeed is unacceptable",SCROPPED_SPRITE_NO_MAP_CROP:"Use of the CroppedSpriteMover will cause problems whenn cropRect of IsoMap is not defined"},t.dirs={DOWN:0,LEFT_DOWN:1,LEFT:2,LEFT_UP:3,UP:4,RIGHT_UP:5,RIGHT:6,RIGHT_DOWN:7},t.getAdjescentTiles=function(t,i){var s=[[t-2,i],[t+2,i],[t,i-1],[t,i+1],[t-1,i],[t-1,i],[t+1,i],[t+1,i]];return 0==t%2?(s[4][1]++,s[6][1]++):(s[5][1]--,s[7][1]--),s},t.getAdjescentTile=function(i,s,e){var o=t.dirs,r=[i,s];switch(e){case o.UP:r[0]-=2;break;case o.DOWN:r[0]+=2;break;case o.LEFT:r[1]--;break;case o.RIGHT:r[1]++;break;case o.RIGHT_UP:r[0]--,0==i%2&&r[1]++;break;case o.LEFT_UP:r[0]--,i%2&&r[1]--;break;case o.RIGHT_DOWN:r[0]++,0==i%2&&r[1]++;break;case o.LEFT_DOWN:r[0]++,i%2&&r[1]--}return r},t}(),isogame.SpriteManager=function(){function t(t){this.map=t,this.movables=new isogame.ArrayList}return t.prototype={add:function(t){this.movables.add(t)},remove:function(t){this.movables.remove(t,this._movableComparator)},_movableComparator:function(t,i){return t===i},update:function(){this.movables.iterate(function(t,i){i.update()})},switchRow:function(t,i){t.Yindex=i,t.relY=0},switchCol:function(t,i){t.Xindex=i,t.relX=0},switchColRow:function(t,i,s){t.Yindex=i,t.Xindex=s,t.relX=0,t.relY=0},getMovablesInCropArea:function(t){var i={};return this.movables.iterate(function(s,e){if(e.Xindex>t.x-2&&e.Xindex<t.x+t.width+2&&e.Yindex>t.y-2&&e.Yindex<t.y+t.height+2){var o=e.Yindex,r=e.Xindex;i[o]||(i[o]={}),i[o][r]||(i[o][r]=[]),i[o][r].push(e)}}),i}},t}(),isogame.TilePainter=function(){function t(t,i){this.drawInfoCanvas=i,this.map=t,this.th=this.map._bytes.th,this.thh=this.map._bytes.thh,this.image=t._image,this.floor=t._floorCanvas.getContext("2d"),this.floor2=t._floor2Canvas.getContext("2d"),this.item=t._itemCanvas.getContext("2d"),t._infoCanvas&&(this.info=t._infoCanvas.getContext("2d")),this.bytes=t._bytes,this.slices=[];for(var s=0;t._data.slices.length>s;s++){var e=t._data.slices[s];this.slices[e._id]=e}this.crop=t._crop,this.yCropTranslate=0,this.xCropTranslate=0,this.xCanvasTranslateAmount=0,this.yCanvasTranslateAmount=0,this.offset={x:0,y:0},t._offset&&(this.offset=t._offset),this.md=0,this.scrollShift=0,this.prevDir=0,this.map._crop&&this.scroll(isogame.Constants.dirs.DOWN),this.cropChanged=!0}return t.prototype={restoreGraphicLayers:function(){this.floor.restore(),this.floor2.restore(),this.item.restore()},drawUnCroppedMap:function(){this.cropChanged&&(this.floor.clearRect(0,0,this.map._floorCanvas.width,this.map._floorCanvas.height),this.floor2.clearRect(0,0,this.map._floor2Canvas.width,this.map._floor2Canvas.height),this.drawInfoCanvas&&this.info.clearRect(0,0,this.map._infoCanvas.width,this.map._infoCanvas.height)),this.item.clearRect(0,0,this.map._floorCanvas.width,this.map._floorCanvas.height),this.floor.restore(),this.floor2.restore();for(var t=this.map._spriteManager.getMovablesInCropArea(new isogame.Rectangle(0,0,this.bytes.data.cols,this.bytes.data.rows)),i=0;this.bytes.data.rows>i;i++){for(var s=0;this.bytes.data.cols>s;s++)if(1==this.bytes.tileExcists(i,s)){this.bytes.movePosTo(i,s);var e=this.bytes.getCoords(),o=e.x-this.xCropTranslate+this.offset.x,r=e.y-this.yCropTranslate+this.offset.y,a=this.bytes.getFloorId(),n=this.bytes.getFloor2Id(),h=this.bytes.getItemId();this.cropChanged&&(a>-1&&this._drawFloorTile(a,o,r),n>-1&&this._drawFloor2Tile(n,o,r),this.drawInfoCanvas&&this._drawTileIdx(i,s,o,r)),h>-1&&this._drawItemTile(h,o,r)}if(t[i]!==void 0){var l=t[i];for(var c in l)for(var p=l[c],d=0;p.length>d;d++)this._drawMovable(p[d])}}this.cropChanged=!1},draw:function(){if(!this.map._crop)return this.drawUnCroppedMap(),void 0;this.cropChanged&&(this._updateCropTranslate(),this.floor.clearRect(-this.xCanvasTranslateAmount,-this.yCanvasTranslateAmount,this.map._floorCanvas.width,this.map._floorCanvas.height),this.floor2.clearRect(-this.xCanvasTranslateAmount,-this.yCanvasTranslateAmount,this.map._floor2Canvas.width,this.map._floor2Canvas.height),this.drawInfoCanvas&&this.info.clearRect(-this.xCanvasTranslateAmount,-this.yCanvasTranslateAmount,this.map._infoCanvas.width,this.map._infoCanvas.height)),this.item.clearRect(-this.xCanvasTranslateAmount,-this.yCanvasTranslateAmount,this.map._floorCanvas.width,this.map._floorCanvas.height),this.item.restore(),this.floor.restore(),this.floor2.restore();for(var t=this.map._crop,i=this.map._spriteManager.getMovablesInCropArea(t),s=t.y-2;t.height+t.y+2>s;s++){for(var e=t.x-2;t.width+t.x+2>e;e++)if(1==this.bytes.tileExcists(s,e)){this.bytes.movePosTo(s,e);var o=this.bytes.getCoords(),r=o.x-this.xCropTranslate,a=o.y-this.yCropTranslate,n=this.bytes.getFloorId(),h=this.bytes.getFloor2Id(),l=this.bytes.getItemId();this.cropChanged&&(n>-1&&this._drawFloorTile(n,r,a),h>-1&&this._drawFloor2Tile(h,r,a),this.drawInfoCanvas&&this._drawTileIdx(s,e,r,a)),l>-1&&this._drawItemTile(l,r,a)}if(i[s]!==void 0){var c=i[s];for(var p in c)for(var d=c[p],_=0;d.length>_;_++)this._drawMovable(d[_])}}this.cropChanged=!1},_drawFloorTile:function(t,i,s){if(this.slices[t]){var e=this.slices[t];this.floor.drawImage(this.image,e._x,e._y,e._w,e._h,i-e._ox+this.th,s-e._oy+this.thh,e._w,e._h)}},_drawFloor2Tile:function(t,i,s){if(this.slices[t]){var e=this.slices[t];this.floor2.drawImage(this.image,e._x,e._y,e._w,e._h,i-e._ox+this.th,s-e._oy+this.thh,e._w,e._h)}},_drawItemTile:function(t,i,s){if(this.slices[t]){var e=this.slices[t];this.item.drawImage(this.image,e._x,e._y,e._w,e._h,i-e._ox+this.th,s-e._oy+this.thh,e._w,e._h)}},_drawTileIdx:function(t,i,s,e){this.info.fillStyle="#ffffff",isogame.TilePainter.drawNumber(this.info,t,s+this.bytes.th-5,e+this.bytes.thh-3,!0),this.info.fillRect(s+this.bytes.th,e+this.bytes.thh,1,1),isogame.TilePainter.drawNumber(this.info,i,s+this.bytes.th+1,e+this.bytes.thh-3)},_drawMovable:function(t){if(void 0!==t){t.Xindex,t.Yindex,this.bytes.movePosTo(t.Yindex,t.Xindex);var i=this.bytes.getCoords();t.mapX=i.x+t.relX+this.bytes.th,t.mapY=i.y+t.relY+this.bytes.thh,this.map._crop?(t.mapX-=this.xCropTranslate,t.mapY-=this.yCropTranslate):this.offset&&(t.mapX+=this.offset.x,t.mapY+=this.offset.y),t.draw(this.item,t.mapX,t.mapY)}},setMapMoveTranslate:function(t,i){this.xCanvasTranslateAmount+=t,this.yCanvasTranslateAmount+=i,this.floor.translate(t,i),this.floor2.translate(t,i),this.item.translate(t,i),this.info&&this.info.translate(t,i),this.cropChanged=!0},scroll:function(t){var i,s=!1;switch(t){case isogame.Constants.dirs.DOWN:this.crop.y-=2,s=!0,this.setMapMoveTranslate(0,-this.yCanvasTranslateAmount);break;case isogame.Constants.dirs.UP:this.crop.y+=2,s=!0,this.setMapMoveTranslate(0,-this.yCanvasTranslateAmount);break;case isogame.Constants.dirs.LEFT:this.crop.x+=1,this.setMapMoveTranslate(-this.xCanvasTranslateAmount+this.md,0),s=!0;break;case isogame.Constants.dirs.RIGHT:this.crop.x-=1,this.setMapMoveTranslate(-this.xCanvasTranslateAmount+this.md,0),s=!0;break;case isogame.Constants.dirs.RIGHT_DOWN:s=!0,0==this.crop.y%2?(this.scrollShift=this.prevDir,i=1-this.prevDir,this.md=0):(this.scrollShift=0,i=0,this.md=this.map._bytes.th),this.setMapMoveTranslate(-this.xCanvasTranslateAmount+this.md,-this.yCanvasTranslateAmount),this.crop.x-=i,this.crop.y-=1,this.prevDir=0;break;case isogame.Constants.dirs.RIGHT_UP:s=!0,0==this.crop.y%2?(this.scrollShift=this.prevDir,i=1-this.prevDir,this.md=0):(this.scrollShift=0,i=0,this.md=this.map._bytes.th),this.setMapMoveTranslate(-this.xCanvasTranslateAmount+this.md,-this.yCanvasTranslateAmount),this.crop.x-=i,this.crop.y+=1,this.prevDir=0;break;case isogame.Constants.dirs.LEFT_DOWN:s=!0,0==this.crop.y%2?(this.scrollShift=this.prevDir,i=this.prevDir,this.md=0):(this.scrollShift=0,i=0,this.md=-this.map._bytes.th),this.setMapMoveTranslate(-this.xCanvasTranslateAmount+this.md,-this.yCanvasTranslateAmount),this.crop.x+=i,this.crop.y-=1,this.prevDir=1;break;case isogame.Constants.dirs.LEFT_UP:s=!0,0==this.crop.y%2?(this.scrollShift=this.prevDir,i=this.prevDir,this.md=0):(this.scrollShift=0,i=0,this.md=-this.map._bytes.th),this.setMapMoveTranslate(-this.xCanvasTranslateAmount+this.md,-this.yCanvasTranslateAmount),this.crop.x+=i,this.crop.y+=1,this.prevDir=1}s&&(this.cropChanged=!0)},_updateCropTranslate:function(){this.xCropTranslate=this.crop.x*this.map._bytes.tw,this.yCropTranslate=this.crop.y*this.map._bytes.thh}},t}(),isogame.TilePainter.drawNumber=function(t,i,s,e,o){var r;if(i>9){var a="";a+=i;var n=5,h=0;o&&(h=-(a.length-1)*n);for(var r=0;a.length>r;r++)isogame.TilePainter.drawNumber(t,parseInt(a.charAt(r)),s+h+r*n,e)}else switch(i){case 0:for(r=0;5>r;r++)t.fillRect(s+1,e+r,1,1),t.fillRect(s+3,e+r,1,1);t.fillRect(s+2,e,1,1),t.fillRect(s+2,e+4,1,1);break;case 1:for(r=0;5>r;r++)t.fillRect(s+2,e+r,1,1);t.fillRect(s+1,e,1,1),t.fillRect(s+3,e+4,1,1),t.fillRect(s+1,e+4,1,1);break;case 2:for(r=1;4>r;r++)t.fillRect(s+r,e,1,1),t.fillRect(s+r,e+2,1,1),t.fillRect(s+r,e+4,1,1);t.fillRect(s+3,e+1,1,1),t.fillRect(s+1,e+3,1,1);break;case 3:for(r=1;4>r;r++)t.fillRect(s+r,e,1,1),t.fillRect(s+r,e+2,1,1),t.fillRect(s+r,e+4,1,1);for(r=0;5>r;r++)t.fillRect(s+3,e+r,1,1);break;case 4:for(t.fillRect(s+1,e,1,1),t.fillRect(s+1,e+1,1,1),t.fillRect(s+1,e+2,1,1),t.fillRect(s+2,e+2,1,1),r=0;5>r;r++)t.fillRect(s+3,e+r,1,1);break;case 5:for(r=1;4>r;r++)t.fillRect(s+r,e,1,1),t.fillRect(s+r,e+2,1,1),t.fillRect(s+r,e+4,1,1);t.fillRect(s+1,e+1,1,1),t.fillRect(s+3,e+3,1,1);break;case 6:for(r=1;4>r;r++)t.fillRect(s+r,e,1,1),t.fillRect(s+r,e+2,1,1),t.fillRect(s+r,e+4,1,1);for(r=0;5>r;r++)t.fillRect(s+1,e+r,1,1);t.fillRect(s+3,e+3,1,1);break;case 7:for(r=1;4>r;r++)t.fillRect(s+r,e,1,1);for(r=0;5>r;r++)t.fillRect(s+3,e+r,1,1);break;case 8:for(r=1;4>r;r++)t.fillRect(s+r,e,1,1),t.fillRect(s+r,e+2,1,1),t.fillRect(s+r,e+4,1,1);for(r=0;5>r;r++)t.fillRect(s+3,e+r,1,1),t.fillRect(s+1,e+r,1,1);break;case 9:for(r=1;4>r;r++)t.fillRect(s+r,e,1,1),t.fillRect(s+r,e+2,1,1),t.fillRect(s+r,e+4,1,1);for(r=0;5>r;r++)t.fillRect(s+3,e+r,1,1);t.fillRect(s+1,e+1,1,1)}},isogame.MapBytes=function(){function t(t){this.data=t,this.actions=[],this.passActions=[],this.obstructs=[],this.dirLocks=[],this.coords=[],this.floorIds=[],this.floor2Ids=[],this.itemIds=[],this.mapIndexes=[],this.position=0,this.tw=this.data.tileWidth,this.th=this.tw/2,this.thh=this.th/2,this._createBytes()}return t.prototype={_createBytes:function(){for(var t=0;this.data.rows>t;t++)if(0!=t)for(var i=0;this.data.cols>i;i++){var s=0;if(0==t%2&&(s=this.tw/2),0==i&&0==s);else{var e=i*this.tw+s,o=t*(this.tw/4);this.actions.push(-1),this.passActions.push(-1),this.obstructs.push(!0),this.dirLocks.push([!1,!1,!1,!1,!1,!1,!1,!1]),this.coords.push({x:e,y:o,z:-1}),this.floorIds.push(-1),this.floor2Ids.push(-1),this.itemIds.push(-1),this.mapIndexes.push({y:t,x:i})}}for(var r=0;this.data.tiles.length>r;r++){var a=this.data.tiles[r];this.movePosTo(a._yindex,a._xindex),a._floorid!==void 0&&(this.floorIds[this.position]=a._floorid),a._floor2id!==void 0&&(this.floor2Ids[this.position]=a._floor2id),a._itemid!==void 0&&(this.itemIds[this.position]=a._itemid),a._action!==void 0&&(this.actions[this.position]=a._action),a._passaction!==void 0&&(this.passActions[this.position]=a._passaction),this.obstructs[this.position]=!1,a._obstruct!==void 0&&(this.obstructs[this.position]=a._obstruct)}},tileExcists:function(t,i){return t>this.data.rows-1||1>t||1==t%2&&i>this.data.cols-1||i>this.data.cols-1||1==t%2&&0==i||1>i?!1:!0},movePosTo:function(t,i){1==t%2&&i--,t--;var s=Math.round(t/2);i-=s,this.data.cols*t+i,this.position=this.data.cols*t+i},getTileVo:function(){var t={};return t.dirs=this.dirLocks[this.position],t.floorId=this.floorIds[this.position],t.itemId=this.itemIds[this.position],t.action=this.actions[this.position],t.passAction=this.passActions[this.position],t.obstruct=this.obstructs[this.position],t.x=this.coords[this.position].x,t.y=this.coords[this.position].y,t.z=this.coords[this.position].z,t.xi=this.mapIndexes[this.position].x,t.yi=this.mapIndexes[this.position].y,t},getDirLocks:function(){return this.dirLocks[this.position]},setDirLocks:function(t){this.dirLocks[this.position]=t},getFloorId:function(){return this.floorIds[this.position]},setFloorId:function(t){this.floorIds[this.position]=t},getFloor2Id:function(){return this.floor2Ids[this.position]},setFloor2Id:function(t){this.floor2Ids[this.position]=t},getItemId:function(){return this.itemIds[this.position]},setItemId:function(t){this.itemIds[this.position]=t},getAction:function(){return this.actions[this.position]},setAction:function(t){this.actions[this.position]=t},getPassAction:function(){return this.passActions[this.position]},setPassAction:function(t){this.passActions[this.position]=t},getObstruct:function(){return this.obstructs[this.position]},setObstruct:function(t){this.obstructs[this.position]=t},getCoords:function(){return this.coords[this.position]},getIndexes:function(){return this.mapIndexes[this.position]},isWalkable:function(t,i){return this.tileExcists(t,i),this.movePosTo(t,i),this.obstructs[this.position],this.tileExcists(t,i)?(this.movePosTo(t,i),!this.obstructs[this.position]):!1}},t}(),isogame.Mouse2Tile=function(){function t(t){if(!t.tw)throw Error("Mouse2Tile: specify io.tw ( tilewidth )");var i=t.tw;if(!t.rows)throw Error("Mouse2Tile: specify io.rows ( rows in mapdata )");var s=t.rows;if(!t.cols)throw Error("Mouse2Tile: specify io.cols ( cols in mapdata )");var e=t.cols;if(!t.canvas)throw Error("Mouse2Tile: specify io.canvas ( tw * th )");var o=t.canvas;this.offset={x:0,y:0},t.offset&&(this.offset=t.offset),this.TOPLEFT="#ff0000",this.TOPRIGHT="#00ff00",this.cols=e,this.rows=s,this.tw=i,this.th=this.tw/2,this.thh=this.th/2,this.canvas=o,this.context=o.getContext("2d"),this.context.fillStyle="#000000",this.context.fillRect(0,0,this.tw,this.th),this.context.fillStyle=this.TOPLEFT,this.context.beginPath(),this.context.moveTo(this.th,0),this.context.lineTo(0,this.thh),this.context.lineTo(0,0),this.context.closePath(),this.context.fill(),this.context.fillStyle=this.TOPRIGHT,this.context.beginPath(),this.context.moveTo(this.th,0),this.context.lineTo(this.tw,this.thh),this.context.lineTo(this.tw,0),this.context.closePath(),this.context.fill(),this.context.fillStyle=this.BOTLEFT,this.context.beginPath(),this.context.moveTo(this.th,this.th),this.context.lineTo(0,this.thh),this.context.lineTo(0,this.th),this.context.closePath(),this.context.fill(),this.context.fillStyle=this.BOTRIGHT,this.context.beginPath(),this.context.moveTo(this.th,this.th),this.context.lineTo(this.tw,this.thh),this.context.lineTo(this.tw,this.th),this.context.closePath(),this.context.fill()}return t.prototype={getIndexes:function(t,i){t-=this.offset.x,i-=this.offset.y;var s=!1,e=i%this.thh,o=i-e,r=Math.round(o/this.thh),a=t%this.tw,n=t-a,h=Math.round(n/this.tw);1==r%2?s=!0:a>this.th?n+=this.th:(n-=this.th,h-=1);var l=i-o,c=t-n,p=this.context.getImageData(c,l,1,1),d=p.data;return d[0]>130?(s&&(h-=1),r-=1):d[1]>130&&(s||(h+=1),r-=1),new isogame.Point(h,r)},converRGB2String:function(t,i,s){var e=t+256*i+65536*s;return"#"+e.toString(16)}},t}(),isogame.IsoMap=function(){function t(t){var i="IsoMap.setNewData::";if(!t.mapData)throw Error(i+"please specify io.mapData ( json map data )");if(!t.div)throw Error(i+"please specify a root div to append iso canvases in");if(!t.cwidth)throw Error(i+"please specify a cwidth value for the iso canvases");if(!t.cheight)throw Error(i+"please specify a cheight value for the iso canvases");this._data=t.mapData,this._bytes=new isogame.MapBytes(t.mapData),this._div=t.div,this._cwidth=t.cwidth,this._cheight=t.cheight,this._crop=t.mapCrop,this._offset=t.mapOffset,t.m2tCanvas?(this._m2tCanvas=t.m2tCanvas,this._m2tCanvas.style.width=t.mapData.tileWidth+"px",this._m2tCanvas.style.height=t.mapData.tileWidth/2+"px"):(this._m2tCanvas=this._createCanvasLayer("iso_m2t",t.mapData.tileWidth,t.mapData.tileWidth/2),this._m2tCanvas.style.visibility="hidden"),this._floorCanvas=t.floorCanvas?t.floorCanvas:this._createCanvasLayer("iso_floor",this._cwidth,this._cheight),this._floor2Canvas=t.floor2Canvas?t.floor2Canvas:this._createCanvasLayer("iso_floor2",this._cwidth,this._cheight),this._itemCanvas=t.itemCanvas?t.itemCanvas:this._createCanvasLayer("iso_item",this._cwidth,this._cheight),this._mouseLyr=t.mouseCanvas?t.mouseCanvas:this._createCanvasLayer("iso_mouse",this._cwidth,this._cheight),t.infoCanvas?this._infoCanvas=t.infoCanvas:t.debug&&(this._infoCanvas=this._createCanvasLayer("iso_info",this._cwidth,this._cheight));for(var s=[this._floorCanvas,this._floor2Canvas,this._itemCanvas,this._mouseLyr,this._infoCanvas,this.infoCanvas],e=0;s.length>e;e++){var o=s[e];o&&(o.width=this._cwidth,o.height=this._cheight,o.style.width=this._cwidth+"px",o.style.height=this._cheight+"px")}var r=this._mouseLyr.getContext("2d");r.fillRect(0,0,r.width,r.height);var a={tw:t.mapData.tileWidth,rows:t.mapData.rows,cols:t.mapData.cols,canvas:this._m2tCanvas};!this._crop&&this._offset&&(a.offset=this._offset),this._m2t=new isogame.Mouse2Tile(a),this._image=new Image,this._spriteManager=new isogame.SpriteManager(this),this._tilePainter=new isogame.TilePainter(this,null!=this._infoCanvas),this._firstPerson=null}return t.prototype={_createCanvasLayer:function(t,i,s){var e=document.createElement("canvas");return this._div.appendChild(e),e.style.position="absolute",e.id=t,e.width=i,e.height=s,e},setup:function(){this._imageLoaded=!1;var t=this;this._image.onload=function(){var i=setInterval(function(){t._image.width>0&&(clearInterval(i),t._imageLoaded=!0,t._tilePainter.drawUnCroppedMap(),t.onReady())},40)},this._image.src=this._data.grpxPrefix?this._data.grpxPrefix+this._data.graphics:this._data.graphics},destroy:function(){this._div.removeChild(this._floorCanvas),this._div.removeChild(this._floor2Canvas),this._div.removeChild(this._itemCanvas),this._div.removeChild(this._mouseLyr),this._div.removeChild(this._m2tCanvas),this._infoCanvas&&this._div.removeChild(this._infoCanvas)},restoreGraphicLayers:function(){this._tilePainter.restoreGraphicLayers()},getCanvasses:function(){var t={};return t.floor=this._floorCanvas,t.floor2=this._floor2Canvas,t.item=this._itemCanvas,t.mouse=this._mouseLyr,t.m2t=this._m2tCanvas,this._infoCanvas&&t._infoCanvas,t},addMovable:function(t,i,s){t.initialYindex=t.Yindex=s,t.initialXindex=t.Xindex=i,this._spriteManager.add(t)},removeMovable:function(t){this._spriteManager.remove(t)},onReady:function(){},update:function(){this._spriteManager.update()},draw:function(t){this._tilePainter.draw(t)}},t}(),isogame.AIsoSheet=function(){function t(t,i,s){this._visible=!0,this._stopped=!0,this._ox=i,this._oy=s,this._dir=0,this._sheet=t,this._currFrame=0,this._prevFrame=0,this._currDir=0,this._playLoops=-1,this._currPlayLoop=0}return t.prototype={draw:function(){},setVisible:function(t){this._visible=t},getVisible:function(){return this._visible},gotoAndStop:function(t){this._sheet.frames.length>t&&(this._currFrame=t),this._stopped=!0},gotoAndPlay:function(t){this._sheet.frames.length>t&&(this._currFrame=t),this._stopped=!1},play:function(t){this._playLoops=-1,this._currPlayLoop=0,t>0&&(this._playLoops=t),this._stopped=!1},stop:function(){this._stopped=!0},setDirection:function(t){this._currDir=t}},t}(),isogame.IsoAnimationSheet=function(){function t(t,i,s,e){isogame.AIsoSheet.apply(this,arguments),this._framesPerDir=e}return t.prototype=ooputils.inherit(isogame.AIsoSheet.prototype),ooputils.extend(t.prototype,{constructor:t,draw:function(t,i,s){if(this._visible){var e=this._sheet.getFrameData(this._currDir*this._framesPerDir+this._currFrame);e&&(i+=this._ox,s+=this._oy,t.drawImage(this._sheet._image,e.x,e.y,e.width,e.height,i,s,e.width,e.height))}}}),t.prototype.update=function(){this._stopped||(this._prevFrame=this._currFrame,this._currFrame<this._framesPerDir-1?this._currFrame++:(this._currFrame=0,this._currPlayLoop++,this._currPlayLoop==this._playLoops&&this.stop()))},t}(),isogame.IsoDirAnimationSheet=function(){function t(t,i,s,e){isogame.AIsoSheet.apply(this,arguments),this._frames=e}return t.prototype=ooputils.inherit(isogame.AIsoSheet.prototype),ooputils.extend(t.prototype,{constructor:t,draw:function(t,i,s){if(this._visible){var e=this._sheet.getFrameData(this._currFrame);e&&(i+=this._ox,s+=this._oy,t.drawImage(this._sheet._image,e.x,e.y,e.width,e.height,i,s,e.width,e.height))}}}),t.prototype.update=function(){this._stopped||(this._prevFrame=this._currFrame,this._currFrame<this._frames-1?this._currFrame++:(this._currFrame=0,this._currPlayLoop++,this._currPlayLoop==this._playLoops&&(this.stop(),this.animationComplete())))},t}(),isogame.IsoStillSheet=function(){function t(){isogame.AIsoSheet.apply(this,arguments)}return t.prototype=ooputils.inherit(isogame.AIsoSheet.prototype),ooputils.extend(t.prototype,{constructor:t,draw:function(t,i,s){if(this._visible){var e=this._sheet.getFrameData(this._currDir);e&&(i+=this._ox,s+=this._oy,t.drawImage(this._sheet._image,e.x,e.y,e.width,e.height,i,s,e.width,e.height))}}}),t}(),isogame.PngSheet=function(){function t(t,i){if(this._rect=i,this.frames=[],t.src)this._src=t.src,this._image=t,this._imageLoaded=!0,this._sliceImage(),this.onReady();else{this._src=t,this._image=new Image,this._imageLoaded=!1;var s=this;this._image.onload=function(){s._imageLoaded=!0,s._sliceImage(),s.onReady()},this._image.src=t}}return t.prototype={_sliceImage:function(){for(var t=0,i=0;this._image.height>i;){for(;this._image.width>t;)this.frames.push(new isogame.Rectangle(t,i,this._rect.width,this._rect.height)),t+=this._rect.width;i+=this._rect.height,t=0}},getFrameData:function(t){var i=this.frames;return i.length>=t&&t>0?i[t]:i[0]},onReady:function(){}},t}(),isogame.Movable=function(){function t(){this.animatedSprites=[],this.stillSprites=[],this.displayList=[],this.relX=0,this.relY=0,this.mapX=0,this.mapY=0,this.initialXindex=0,this.initialYindex=0,this.Xindex=0,this.Yindex=0,this.mover=null,this.direction=0,this.pathfinder=null,this.mouseCanvas=null,this.mouseContext=null,this.totalRect=null}return t.prototype={addAnimatedSpriteSheet:function(t){this.animatedSprites.push(t),this.displayList.push(t)},addStillSpriteSheet:function(t){this.stillSprites.push(t),this.displayList.push(t)},update:function(){this.mover&&this.mover.update();for(var t=0;this.animatedSprites.length>t;t++)this.animatedSprites[t].update()},draw:function(t,i,s){for(var e=0;this.displayList.length>e;e++)this.displayList[e].draw(t,i,s)},gotoAndStop:function(t){for(var i=0;this.animatedSprites.length>i;i++)this.animatedSprites[i].gotoAndStop(t)},gotoAndPlay:function(t){for(var i=0;this.animatedSprites.length>i;i++)this.animatedSprites[i].gotoAndPlay(t)},play:function(t){for(var i=0;this.animatedSprites.length>i;i++)this.animatedSprites[i].play(t)},stop:function(){for(var t=0;this.animatedSprites.length>t;t++)this.animatedSprites[t].stop()},setDirection:function(t){this.direction=t;for(var i=0;this.displayList.length>i;i++)this.displayList[i].setDirection(t)},getDirection:function(){return this.direction},asignMover:function(t){this.mover=t},getMover:function(){return this.mover},walkPathTo:function(t,i){this.pathfinder=new isogame.AStar(this._bytes,this.Yindex,this.Xindex,t,i,265)},walkPathAt:function(t,i){this.pathfinder=new isogame.AStar(this._bytes,this.Yindex,this.Xindex,t,i,265)},enableMouse:function(){this.mouseCanvas=document.createElement("canvas");var t=this.getBounds();this.totalRect=new isogame.Rectangle(t.minX,t.minY,Math.abs(t.minX-t.maxX),Math.abs(t.minY-t.maxY)),this.mouseCanvas.width=this.totalRect.width,this.mouseCanvas.height=this.totalRect.height,this.mouseContext=this.mouseCanvas.getContext("2d")},hitPointTest:function(t,i){this.mouseContext.clearRect(0,0,this.mouseCanvas.width,this.mouseCanvas.height),this.draw(this.mouseContext,-this.totalRect.x,-this.totalRect.y);var s=this.mapX+this.relX+this.totalRect.x,e=this.mapY+this.relY+this.totalRect.y,o=t-s,r=i-e;if(0>o||0>r)return!1;if(o>this.totalRect.width||r>this.totalRect.height)return!1;var a=this.mouseContext.getImageData(o,r,1,1).data;return isogame.compareArrays(a,[0,0,0,0,0,0,0,0])?!1:!0},getBounds:function(){for(var t=this.displayList[0]._ox,i=this.displayList[0]._oy,s=t+this.displayList[0]._sheet._rect.width,e=i+this.displayList[0]._sheet._rect.height,o=1;this.displayList.length>o;o++){var r=this.displayList[o]._ox,a=this.displayList[o]._oy,n=(r+this.displayList[o]._sheet._rect.width,a+this.displayList[o]._sheet._rect.height);t>r&&(t=r),i>a&&(i=a),n>e&&(e=n)}return{minX:t,minY:i,maxX:s,maxY:e}}},t}(),isogame.FirstPerson=function(){function t(){isogame.Movable.apply(this,arguments)}return t.prototype=ooputils.inherit(isogame.Movable.prototype),ooputils.extend(t.prototype,{constructor:t,dummyfunc:function(){}}),t}(),isogame.Enemy=function(){function t(){isogame.Movable.apply(this,arguments)}return t.prototype=ooputils.inherit(isogame.Movable.prototype),ooputils.extend(t.prototype,{constructor:t,dummyfunc:function(){}}),t}(),isogame.AMover=function(){function t(t,i,s){this._map=i,this._bytes=i._bytes,this._sm=i._spriteManager,this._movable=t,this._stepX=0,this._stepY=0;var e=this._map.tw/s,o=(""+e).split(".");if(o.length>1)throw isogame.Constants.errors.SPITE_MOVE_SPEED_ODD;this._speed=s,this._moveInRequest=!1,this._currDir=888,this._dirFuncs=[this.down,this.leftdown,this.left,this.leftup,this.up,this.rightup,this.right,this.rightdown],this._ascendingsFuncs=[this.ascDown,this.ascLeftDown,this.ascLeft,this.ascLeftUp,this.ascUp,this.ascRightUp,this.ascRight,this.ascRightDown],this._mouseTarget}return t.prototype={update:function(){},getFutureIndexes:function(){return this._currDir>7?{y:this._movable.Yindex,x:this._movable.Xindex}:this._ascendingsFuncs[this._currDir](this._movable.Yindex,this._movable.Xindex)},goInDir:function(t){this._currDir=t,this._dirFuncs[t](this)},up:function(t){t._stepY=2*t._speed,t._stepX=0},down:function(t){t._stepY=2*t._speed,t._stepX=0},left:function(t){t._stepY=0,t._stepX=2*t._speed},right:function(t){t._stepY=0,t._stepX=2*t._speed},leftup:function(t){t._stepY=1*t._speed,t._stepX=2*t._speed},rightup:function(t){t._stepY=1*t._speed,t._stepX=2*t._speed},leftdown:function(t){t._stepY=1*t._speed,t._stepX=2*t._speed},rightdown:function(t){t._stepY=1*t._speed,t._stepX=2*t._speed},ascUp:function(t,i){return{y:t-2,x:i}},ascDown:function(t,i){return{y:t+2,x:i}},ascLeft:function(t,i){return{y:t,x:i-1}},ascRight:function(t,i){return{y:t,x:i+1}},ascLeftUp:function(t,i){return 0==t%2?{y:t-1,x:i}:{y:t-1,x:i-1}},ascRightUp:function(t,i){return 0==t%2?{y:t-1,x:i+1}:{y:t-1,x:i}},ascLeftDown:function(t,i){return 0==t%2?{y:t+1,x:i}:{y:t+1,x:i-1}},ascRightDown:function(t,i){return 0==t%2?{y:t+1,x:i+1}:{y:t+1,x:i}},stop:function(){this._currDir=888,this._stepY=0,this._stepX=0,this._moveInRequest=!1},isRequested:function(){return this._moveInRequest},setRequested:function(t){this._moveInRequest=t},isSnapped:function(){return 0==this._movable.relX&&0==this._movable.relY},setSnapped:function(){},getDirection:function(){return this._currDir},setDirection:function(t){this._currDir=t},getSpeed:function(){return this._speed},setSpeed:function(t){this._speed=t},getMap:function(){return this._map},setMap:function(t){this._map=t},getXstep:function(){return this._stepX},getYstep:function(){return this._stepY},getMovable:function(){return this._movable},setXstep:function(t){this._stepX=t},setYstep:function(t){this._stepY=t},getMouseTarget:function(){return this._mouseTarget},setMouseTarget:function(t){this._mouseTarget=t}},t}(),isogame.MapMover=function(){function t(){isogame.AMover.apply(this,arguments),this.sm=this._map._spriteManager,this.tp=this._map._tilePainter,this.resolvers=[this.resolveDown,this.resolveLeftDown,this.resolveLeft,this.resolveLeftUp,this.resolveUp,this.resolveRightUp,this.resolveRight,this.resolveRightDown],this._m2t=this._map._m2t}return t.prototype=ooputils.inherit(isogame.AMover.prototype),ooputils.extend(t.prototype,{constructor:t,update:function(){!this.isSnapped()||8>this._currDir?this.resolvers[this._currDir](this):this.stop()},resolveUp:function(t){var i=t._movable;return!t.isSnapped()||t._moveInRequest&&t._bytes.isWalkable(i.Yindex-2,i.Xindex)?(i.relY=i.relY-t._stepY,t.tp.setMapMoveTranslate(0,t._stepY),i.relY==-t._bytes.th&&(t._sm.switchRow(i,i.Yindex-2),t.tp.scroll(isogame.Constants.dirs.DOWN,i)),void 0):(t._currDir=8,void 0)},resolveDown:function(t){var i=t._movable;return!t.isSnapped()||t._moveInRequest&&t._bytes.isWalkable(i.Yindex+2,i.Xindex)?(i.relY=i.relY+t._stepY,t.tp.setMapMoveTranslate(0,-t._stepY),i.relY==t._bytes.th&&(t._sm.switchRow(i,i.Yindex+2),t.tp.scroll(isogame.Constants.dirs.UP,i)),void 0):(t._currDir=8,void 0)},resolveLeft:function(t){var i=t._movable;return!t.isSnapped()||t._moveInRequest&&t._bytes.isWalkable(i.Yindex,i.Xindex-1)?(i.relX=i.relX-t._stepX,t.tp.setMapMoveTranslate(t._stepX,0),i.relX==-t._bytes.tw&&(t._sm.switchCol(i,i.Xindex-1),t.tp.scroll(isogame.Constants.dirs.RIGHT,i)),void 0):(t._currDir=8,void 0)},resolveRight:function(t){var i=t._movable;return!t.isSnapped()||t._moveInRequest&&t._bytes.isWalkable(i.Yindex,i.Xindex+1)?(i.relX=i.relX+t._stepX,t.tp.setMapMoveTranslate(-t._stepX,0),i.relX==t._bytes.tw&&(t._sm.switchCol(i,i.Xindex+1),t.tp.scroll(isogame.Constants.dirs.LEFT,i)),void 0):(t._currDir=8,void 0)},resolveLeftUp:function(t){var i,s=t._movable;return!t.isSnapped()||(i=s.Xindex,1==s.Yindex%2&&i--,t._moveInRequest&&t._bytes.isWalkable(s.Yindex-1,i))?(s.relX=s.relX-t._stepX,s.relY=s.relY-t._stepY,t.tp.setMapMoveTranslate(t._stepX,t._stepY),s.relX==-t._bytes.th&&(i=s.Xindex,1==s.Yindex%2&&i--,t._sm.switchColRow(s,s.Yindex-1,i),t.tp.scroll(isogame.Constants.dirs.RIGHT_DOWN,s)),void 0):(t._currDir=8,void 0)},resolveLeftDown:function(t){var i,s=t._movable;
return!t.isSnapped()||(i=s.Xindex,1==s.Yindex%2&&i--,t._moveInRequest&&t._bytes.isWalkable(s.Yindex+1,i))?(s.relX=s.relX-t._stepX,s.relY=s.relY+t._stepY,t.tp.setMapMoveTranslate(t._stepX,-t._stepY),s.relX==-t._bytes.th&&(i=s.Xindex,1==s.Yindex%2&&i--,t._sm.switchColRow(s,s.Yindex+1,i),t.tp.scroll(isogame.Constants.dirs.RIGHT_UP,s)),void 0):(t._currDir=8,void 0)},resolveRightUp:function(t){var i,s=t._movable;return!t.isSnapped()||(i=s.Xindex,0==s.Yindex%2&&i++,t._moveInRequest&&t._bytes.isWalkable(s.Yindex-1,i))?(s.relX=s.relX+t._stepX,s.relY=s.relY-t._stepY,t.tp.setMapMoveTranslate(-t._stepX,t._stepY),s.relX==t._bytes.th&&(i=s.Xindex,0==s.Yindex%2&&i++,t._sm.switchColRow(s,s.Yindex-1,i),t.tp.scroll(isogame.Constants.dirs.LEFT_DOWN,s)),void 0):(t._currDir=8,void 0)},resolveRightDown:function(t){var i,s=t._movable;return!t.isSnapped()||(i=s.Xindex,0==s.Yindex%2&&i++,t._moveInRequest&&t._bytes.isWalkable(s.Yindex+1,i))?(s.relX=s.relX+t._stepX,s.relY=s.relY+t._stepY,t.tp.setMapMoveTranslate(-t._stepX,-t._stepY),s.relX==t._bytes.th&&(i=s.Xindex,0==s.Yindex%2&&i++,t._sm.switchColRow(s,s.Yindex+1,i),t.tp.scroll(isogame.Constants.dirs.LEFT_UP,s)),void 0):(t._currDir=8,void 0)},stop:function(){this._moveInRequest=!1}}),t}(),isogame.SpriteMover=function(){function t(){isogame.AMover.apply(this,arguments),this.sm=this._map._spriteManager,this.resolvers=[this.resolveDown,this.resolveLeftDown,this.resolveLeft,this.resolveLeftUp,this.resolveUp,this.resolveRightUp,this.resolveRight,this.resolveRightDown],this._m2t=this._map._m2t}return t.prototype=ooputils.inherit(isogame.AMover.prototype),ooputils.extend(t.prototype,{constructor:t,update:function(){!this.isSnapped()||8>this._currDir?this.resolvers[this._currDir](this):this.stop()},resolveUp:function(t){var i=t._movable;return!t.isSnapped()||t._moveInRequest&&t._bytes.isWalkable(i.Yindex-2,i.Xindex)?(i.relY=i.relY-t._stepY,i.relY==-t._bytes.th&&t._sm.switchRow(i,i.Yindex-2),void 0):(t._currDir=8,void 0)},resolveDown:function(t){var i=t._movable;return!t.isSnapped()||t._moveInRequest&&t._bytes.isWalkable(i.Yindex+2,i.Xindex)?(i.relY=i.relY+t._stepY,i.relY==t._bytes.th&&t._sm.switchRow(i,i.Yindex+2),void 0):(t._currDir=8,void 0)},resolveLeft:function(t){var i=t._movable;return!t.isSnapped()||t._moveInRequest&&t._bytes.isWalkable(i.Yindex,i.Xindex-1)?(i.relX=i.relX-t._stepX,i.relX==-t._bytes.tw&&t._sm.switchCol(i,i.Xindex-1),void 0):(t._currDir=8,void 0)},resolveRight:function(t){var i=t._movable;return!t.isSnapped()||t._moveInRequest&&t._bytes.isWalkable(i.Yindex,i.Xindex+1)?(i.relX=i.relX+t._stepX,i.relX==t._bytes.tw&&t._sm.switchCol(i,i.Xindex+1),void 0):(t._currDir=8,void 0)},resolveLeftUp:function(t){var i,s=t._movable;return!t.isSnapped()||(i=s.Xindex,1==s.Yindex%2&&i--,t._moveInRequest&&t._bytes.isWalkable(s.Yindex-1,i))?(s.relX=s.relX-t._stepX,s.relY=s.relY-t._stepY,s.relX==-t._bytes.th&&(i=s.Xindex,1==s.Yindex%2&&i--,t._sm.switchColRow(s,s.Yindex-1,i)),void 0):(t._currDir=8,void 0)},resolveLeftDown:function(t){var i,s=t._movable;return!t.isSnapped()||(i=s.Xindex,1==s.Yindex%2&&i--,t._moveInRequest&&t._bytes.isWalkable(s.Yindex+1,i))?(s.relX=s.relX-t._stepX,s.relY=s.relY+t._stepY,s.relX==-t._bytes.th&&(i=s.Xindex,1==s.Yindex%2&&i--,t._sm.switchColRow(s,s.Yindex+1,i)),void 0):(t._currDir=8,void 0)},resolveRightUp:function(t){var i,s=t._movable;return!t.isSnapped()||(i=s.Xindex,0==s.Yindex%2&&i++,t._moveInRequest&&t._bytes.isWalkable(s.Yindex-1,i))?(s.relX=s.relX+t._stepX,s.relY=s.relY-t._stepY,s.relX==t._bytes.th&&(i=s.Xindex,0==s.Yindex%2&&i++,t._sm.switchColRow(s,s.Yindex-1,i)),void 0):(t._currDir=8,void 0)},resolveRightDown:function(t){var i,s=t._movable;return!t.isSnapped()||(i=s.Xindex,0==s.Yindex%2&&i++,t._moveInRequest&&t._bytes.isWalkable(s.Yindex+1,i))?(s.relX=s.relX+t._stepX,s.relY=s.relY+t._stepY,s.relX==t._bytes.th&&(i=s.Xindex,0==s.Yindex%2&&i++,t._sm.switchColRow(s,s.Yindex+1,i)),void 0):(t._currDir=8,void 0)},stop:function(){this._currDir=888,this._moveInRequest=!1}}),t}(),isogame.SpriteMapMover=function(){function t(t,i,s){this._mapMover=new isogame.MapMover(t,i,s),this._spriteMover=new isogame.SpriteMover(t,i,s),this.currMover=this._spriteMover}return t}(),isogame.KeyControl=function(){function t(){$(document).keydown(this._keypress),$(document).keyup(this._keyup)}return t.prototype={_keyup:function(t){isogame.KeyControl._keydirs[t.keyCode]&&(isogame.KeyControl._keydirs[t.keyCode][0]=!1)},_keypress:function(t){isogame.KeyControl._keydirs[t.keyCode]&&(isogame.KeyControl._keydirs[t.keyCode][0]=!0)},getDirection:function(){return isogame.KeyControl._keydirs[37][0]?isogame.KeyControl._keydirs[38][0]?isogame.Constants.dirs.LEFT_UP:isogame.KeyControl._keydirs[40][0]?isogame.Constants.dirs.LEFT_DOWN:isogame.KeyControl._keydirs[37][1]:isogame.KeyControl._keydirs[38][0]?isogame.KeyControl._keydirs[37][0]?isogame.Constants.dirs.LEFT_UP:isogame.KeyControl._keydirs[39][0]?isogame.Constants.dirs.RIGHT_UP:isogame.KeyControl._keydirs[38][1]:isogame.KeyControl._keydirs[39][0]?isogame.KeyControl._keydirs[38][0]?isogame.Constants.dirs.RIGHT_UP:isogame.KeyControl._keydirs[40][0]?isogame.Constants.dirs.RIGHT_DOWN:isogame.KeyControl._keydirs[39][1]:isogame.KeyControl._keydirs[40][0]?isogame.KeyControl._keydirs[37][0]?isogame.Constants.dirs.LEFT_DOWN:isogame.KeyControl._keydirs[39][0]?isogame.Constants.dirs.RIGHT_DOWN:isogame.KeyControl._keydirs[40][1]:8}},t._keydirs=[],t._keydirs[37]=[!1,isogame.Constants.dirs.LEFT],t._keydirs[38]=[!1,isogame.Constants.dirs.UP],t._keydirs[39]=[!1,isogame.Constants.dirs.RIGHT],t._keydirs[40]=[!1,isogame.Constants.dirs.DOWN],t}(),isogame.MouseControl=function(){function t(t,s){this.tileClicked=null,this.map=t,this.movable=s,this.pathEvt=null,this.pathEvtBuff=null,this.curr=-1,this.pathBuffering=!1;var e=this;this.map._mouseLyr.onclick=function(t){var s=t.layerX+e.map._tilePainter.xCropTranslate+e.map._tilePainter.md,o=t.layerY+e.map._tilePainter.yCropTranslate;if(i=e.map._m2t.getIndexes(s,o,e.map),e.pathEvt){e.pathBuffering=!0;var r=e.movable.mover.getFutureIndexes(),a=new isogame.AStar(e.map._tilePainter.bytes,r.y,r.x,i.y,i.x,1e3);a.onPathFound=function(t){e.pathEvtBuff=t},a.onPathNotFound=function(){console.log("MouseControl.astar.onPathNotFound"),e.pathEvtBuff=null},a.start()}else{var n=e.movable.Yindex,h=e.movable.Xindex,a=new isogame.AStar(e.map._tilePainter.bytes,n,h,i.y,i.x,1e3);a.onPathFound=function(t){e.pathEvt=t,e.curr=-1},a.onPathNotFound=function(){console.log("MouseControl.astar.onPathNotFound"),e.pathEvt=null},a.start()}}}return t.prototype={getDirection:function(){if(this.pathEvt){if(this.movable.mover.isSnapped())return this.pathEvtBuff&&(this.pathEvt=this.pathEvtBuff,this.pathEvtBuff=null,this.pathBuffering=!1,this.curr=-1),this.curr++,this.pathEvt.dirArray.length==this.curr?(console.log("path is walked"),this.pathEvt=null,this.curr=-1,8):this.pathEvt.dirArray[this.curr]}else this.pathEvtBuff&&(this.pathEvt=this.pathEvtBuff,this.pathEvtBuff=null,this.pathBuffering=!1,this.curr=-1);return 8}},t}(),isogame.AStar=function(){function t(t,i,s,e,o,r,a,n){if(!t.tileExcists(e,o))throw Error("isogame.AStar ERROR: "+e+">"+o+" does not excist! ");if(!t.tileExcists(i,s))throw Error("isogame.AStar ERROR: "+i+">"+s+" does not excist! ");this.dir4=n,this.infocanvas=a,this._maxScans=r||255,this._bytes=t,this.tw=this._bytes.tw,this.th=this._bytes.th,this.thh=this._bytes.thh,this._oldX=s,this._oldY=i,this._newX=o,this._newYOdd=e%2,this._newY=e,this._targetTile=e+">"+o,this._bytes.movePosTo(e,o),this._actionMsg=this._bytes.getAction(),this._startTile=i+">"+s,this._pathArray=[],this._dirArray=[],this._reRun=!1,this._closedList={},this._openList={},this._Fscores=[],this._Fscores[0]=0,this._totalScans=0,this._straightDis=8,this._vertDis=16,this._horiDis=16,this._HstraightDis=8,this._HvertDis=10,this._HhoriDis=10,this._retry=0}return t.prototype={start:function(){var t=[];t.parent=null,t.H=this.calcH(this._oldX,this._oldY),t.G=0,t.F=parseInt(t.H+t.G),this._openList[this._startTile]=t,0==this._reRun&&(this._Fscores[1]=[],this._Fscores[1].F=t.F,this._Fscores[1].N=this._startTile),this._action="walkto"==this._actionMsg||"undefined"==this._actionMsg?!1:!0,this.scanAdjacent(this._oldX,this._oldY)},scanAdjacent:function(t,i){this._totalScans+=1;var s=i+">"+t,e=!1;this._closedList[s]=[],this._closedList[s].parent=this._openList[s].parent,this._closedList[s].dir=this._openList[s].dir,this._closedList[s].G=this._openList[s].G,this._closedList[s].H=this._openList[s].H,this._closedList[s].F=this._openList[s].F,delete this._openList[s],this.removeFromHeap(this._Fscores);var o=0;this.dir4&&(o=4);for(var r=o;8>r;r++){if(s==this._targetTile){e=!0;break}var a=0,n=9;switch(r){case 0:n=isogame.Constants.dirs.UP;var h=i-2,l=t;a=this._vertDis;break;case 1:n=isogame.Constants.dirs.DOWN;var h=i+2,l=t;a=this._vertDis;break;case 2:n=isogame.Constants.dirs.LEFT;var h=i,l=t-1;a=this._horiDis;break;case 3:n=isogame.Constants.dirs.RIGHT;var h=i,l=t+1;a=this._horiDis;break;case 4:n=isogame.Constants.dirs.RIGHT_UP;var h=i-1,l=t;0==i%2&&(l=t+1),a=this._straightDis;break;case 5:n=isogame.Constants.dirs.LEFT_UP;var h=i-1,l=t;i%2&&(l=t-1),a=this._straightDis;break;case 6:n=isogame.Constants.dirs.RIGHT_DOWN;var h=i+1,l=t;0==i%2&&(l=t+1),a=this._straightDis;break;case 7:n=isogame.Constants.dirs.LEFT_DOWN;var h=i+1,l=t;i%2&&(l=t-1),a=this._straightDis}var c=h+">"+l,p=this._bytes.isWalkable(h,l);if((p||c==this._targetTile)&&void 0==this._closedList[c])if(void 0==this._openList[c]){var d=this._openList[c]=[];d.parent=s,d.dir=n,d.H=this.calcH(l,h),d.G=this._closedList[s].G+a,d.F=d.G+d.H;var _=this._Fscores.length;this.add2heap(_,c,d.F,this._Fscores),this.drawCheckTile(h,l,!1)}else{var u=this._closedList[s].G+a;if(this._openList[c].G>=u){var d=this._openList[c];d.parent=s,d.dir=n,d.G=u,d.F=u+d.H,this.replaceInHeap(c,this._Fscores,d.F),this.drawCheckTile(h,l,!0)}}}if(1==e||2>this._Fscores.length)1==e?this.tracePathBack(this._targetTile):this.onPathNotFound();else if(this._totalScans<this._maxScans){var f=this._Fscores[1].N.split(">",2);this.scanAdjacent(parseInt(f[1]),parseInt(f[0]))}else this.onPathNotFound()},drawCheckTile:function(t,i){if(this.infocanvas){this._bytes.movePosTo(t,i);var s=this._bytes.getCoords(),e=new isogame.Point(s.x,s.y);e.x+=this.th,e.y+=this.thh,t+">"+i==this._targetTile&&console.log("AStar.drawCheckTile: TARGET FOUND!!!"),this.infocanvas.beginPath(),this.infocanvas.fillStyle="#f00",this.infocanvas.rect(e.x,e.y,2,2),this.infocanvas.fill(),this.infocanvas.closePath()}},nextStep:function(){var t=this._Fscores[1].N.split(">",2);this.scanAdjacent(parseInt(t[1]),parseInt(t[0]))},calcH:function(t,i){this._oldX,this._oldY,this._newX,this._newY;var s=new Number,e=t,o=i,r=i%2,a=new Number,n=new Number,h=new Number,l=new String;for(this._pathArray[0]=i+">"+t,this._pathFound=!1;!this._pathFound;){if(e==this._newX&&o==this._newY){this._pathFound=!0;break}o==this._newY?this._newX>e?(s=1,a=0,n=this._HhoriDis,l="right"):(s=-1,a=0,n=this._HhoriDis,l="left"):e==this._newX&&r==this._newYOdd?o>this._newY?(s=0,a=-2,n=this._HvertDis,l="up"):(s=0,a=2,n=this._HvertDis,l="down"):o>this._newY?this._newX>e||e==this._newX&&r?(s=0,r||(s=1),a=-1,n=this._HstraightDis,l="leftup"):(s=0,r&&(s=-1),a=-1,n=this._HstraightDis,l="rightup"):this._newY>o&&(e>this._newX||e==this._newX&&!r?(s=0,r&&(s=-1),a=1,n=this._HstraightDis,l="leftdown"):(s=0,r||(s=1),a=1,n=this._HstraightDis,l="rightdown")),e+=s,o+=a,h+=n,r=o%2}return 3*h},tracePathBack:function(t){if(void 0!=this._closedList[t].parent){var i=this._closedList[t].parent;this._pathArray.push(i),this._dirArray.push(this._closedList[t].dir),this.tracePathBack(i)}else{this._pathArray.reverse(),this._dirArray.reverse();var s=this._pathArray.length-1;this._pathArray[s]=this._targetTile;var e={};e.pathArray=this._pathArray,e.dirArray=this._dirArray,e.targetTile=this._targetTile,e.mapVO=this._mapVO,e.action=this._action,e.actionMsg=this._actionMsg,this.onPathFound(e)}},swapItem:function(t,i,s){var e=s[t],o=s[i];s[t]=o,s[i]=e},add2heap:function(t,i,s,e){e[t]={},e[t].N=i,e[t].F=s,this.sortHeapAfterAdd(t,e)},replaceInHeap:function(t,i,s){for(var e=1;i.length>e;e++)if(i[e].N==t)return i[e].N=t,i[e].F=s,this.sortHeapAfterAdd(e,i),void 0},sortHeapAfterAdd:function(t,i){var s=Math.floor(t/2);i[s].F>i[t].F&&(this.swapItem(s,t,i),this.sortHeapAfterAdd(s,i))},removeFromHeap:function(t){if(t.length>0){var i=t.length-1;t[1].F=t[i].F,t[1].N=t[i].N,t.pop(),this.sortHeapAfterRemove(1,t)}},sortHeapAfterRemove:function(t,i){var s=2*t,e=2*t+1;if(i.length>3){if(void 0==i[s]||void 0==i[e])return;if(i[t].F<i[s].F&&i[t].F<i[e].F)return;i[s].F<i[e].F?(this.swapItem(s,t,i),this.sortHeapAfterRemove(s,i)):(this.swapItem(e,t,i),this.sortHeapAfterRemove(e,i))}else 3==i.length&&i[1].F>i[2].F&&(this.swapItem(1,2,i),console.log("swapped the last 2."))},onPathNotFound:function(){},onPathFound:function(){}},t}();